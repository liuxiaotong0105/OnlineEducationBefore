(function(){if(!window.performanceInfo||!window.performance||!document.addEventListener){return false}if(window.performance.timing.fetchStart<=0||(new Date(window.performance.timing.fetchStart)).getFullYear()!=(new Date()).getFullYear()){return false}if(window.performanceInfo.firstLoad){return false}window.performanceInfo.firstLoad=true;var schema="http";if(window.location.protocol==="https:"){schema="https"}var pageTimeOut=window.performanceInfo.pageTimeOut||5000;var apiTimeOut=window.performanceInfo.apiTimeOut||2000;function setPageview(){var pathname="";var pageview="";if(!window.performanceInfo.pageview){if(window.location.host.indexOf("huya.com")==-1){return false}pathname=window.location.pathname.substring(window.location.pathname.length-1)=="/"?(window.location.pathname+"index"):window.location.pathname;pageview=(window.location.host+pathname).replace(".html","");window.performanceInfo.pageview=pageview}}setPageview();var yyuid=getCookieVal("yyuid")||0;var server="//metric.huya.com/?";function getCookieVal(cookieName){var arrstr=document.cookie.split("; ");for(var i=0;i<arrstr.length;i=i+1){var kv=arrstr[i].split("=");if(kv[0]==cookieName){return decodeURIComponent(kv[1])}}return""}var platform=(function(){var u=navigator.userAgent;var device="web";if(u.indexOf("Android")>-1||u.indexOf("Adr")>-1){device="android";return device}if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){device="ios";return device}return device})();function toXCodeArray(str){var x=[];for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if(c<128){x.push(c)}else{if(c<2048){x.push(192|(c>>6),128|(c&63))}else{if(c<55296||c>=57344){x.push(224|(c>>12),128|((c>>6)&63),128|(c&63))}else{i++;c=65536+(((c&1023)<<10)|(str.charCodeAt(i)&1023));x.push(240|(c>>18),128|((c>>12)&63),128|((c>>6)&63),128|(c&63))}}}}return x}function xEncode(data,key){var r=t=o="";var i=m=0;var mm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var c1,c2,c3,e1,e2,e3,e4;dArray=toXCodeArray(data);for(i=dArray.length-1,j=0;i>=0;i--){t=dArray[i]^key.charCodeAt(j)^m;r=r+String.fromCharCode(t);j=(++j)%key.length;m=t}i=0;while(i<r.length){c1=r.charCodeAt(i++);c2=r.charCodeAt(i++);c3=r.charCodeAt(i++);e1=c1>>2;e2=((c1&3)<<4)|(c2>>4);e3=((c2&15)<<2)|(c3>>6);e4=c3&63;if(isNaN(c2)){e3=e4=64}else{if(isNaN(c3)){e4=64}}o=o+mm.charAt(e1)+mm.charAt(e2)+mm.charAt(e3)+mm.charAt(e4)}return o}var reportCustom=function(m,timestamp,pageview,sguid){var oAjax=null;var pageview=pageview||window.performanceInfo.pageview;if(window.XDomainRequest){oAjax=new XDomainRequest()}else{oAjax=window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP")}var oReport={"ua":platform+"&"+pageview,"uid":yyuid||0,"sguid":sguid||0,"m":m};window.console&&console.log(oReport);window.HUYASdk&&HUYASdk.log(pageview+":"+JSON.stringify(oReport));var dataPost=JSON.stringify(oReport);var postData=xEncode(dataPost,timestamp+"");var url=server+"ts="+timestamp;oAjax.open("POST",url,true);oAjax.send(postData)};function performanceDate(){var timing=performance.timing;var timeObj={dns:timing.domainLookupEnd-timing.domainLookupStart,tcp:timing.connectEnd-timing.connectStart,ttfb:timing.responseStart-timing.requestStart,trans:timing.responseEnd-timing.responseStart,dom:timing.domInteractive-timing.responseEnd,res:timing.loadEventStart-timing.domContentLoadedEventEnd,firstbyte:timing.responseStart-timing.domainLookupStart,fpt:timing.responseEnd-timing.fetchStart,tti:timing.domInteractive-timing.fetchStart,whiteScreenTime:performanceInfo.whiteScreenTime-timing.fetchStart,firstScreenTime:performanceInfo.firstScreenTime-timing.fetchStart,readyTime:timing.domContentLoadedEventEnd-timing.fetchStart,loadTime:performanceInfo.loadTime-timing.fetchStart};if(window.location.protocol==="https:"&&timing.secureConnectionStart>0){timeObj.ssl=timing.connectEnd-timing.secureConnectionStart}return timeObj}(function(){function timerParam(obj,timestamp){var p=[{"name":"fed.page.performance","its":timestamp,"dim":{"schema":schema},"field":{},"exlog":{"extdesc":""}}];var pageview="report-"+window.performanceInfo.pageview;function recordRequest(p,key,value){var entries=[];if(key=="firstScreenTime"&&value>pageTimeOut&&window.performance.getEntriesByType&&window.performance.getEntriesByType("resource") instanceof Array){var getResourceLowValues=function(arr,num){var newArr=[];arr=arr.sort(function(a,b){return b.duration-a.duration});for(var i=0,len=arr.length;i<len;i++){newArr.push("【duration="+Math.floor(arr[i].duration)+"&name="+arr[i].name.slice(0,150)+"】");if(newArr.length>=num){break}}return newArr};entries=getResourceLowValues(window.performance.getEntriesByType("resource"),2);p[0]["exlog"]["extdesc"]=entries.join("|")}}for(var k in obj){p[0]["field"][k]=obj[k];recordRequest(p,k,obj[k])}return p}function send(data){var timestamp=+new Date();var m=timerParam(data,timestamp);reportCustom(m,timestamp)}var timeNum=0;function performanceReport(){if(timeNum>=50){return false}if(!window.performanceInfo.firstScreenTime){timeNum++;
setTimeout(function(){performanceReport()},200);return false}var reportObj=performanceDate();var sendStatus=true;for(var key in reportObj){if(reportObj[key]<0){sendStatus=false;break}}sendStatus&&send(reportObj)}var onLoad=function(){window.removeEventListener("load",onLoad);window.performanceInfo.loadTime=+new Date();performanceReport()};if(performance.timing.loadEventEnd!=0){onLoad()}else{window.addEventListener("load",onLoad)}})();(function(){function reportLoadStatus(){var timestamp=+new Date();var suc=1;if(!window.performanceInfo.firstScreenTime){suc=0}var m=[{"name":"fed.page.loadStatus","its":timestamp,"suc":suc,"code":0,"value":1,"dim":{"schema":schema},"exdesc":""}];if(!window.performanceInfo.firstScreenTime){m[0].exdesc=(JSON.stringify(performanceDate())+"|||"+navigator.userAgent)}reportCustom(m,timestamp)}if(window.performanceInfo.firstScreenTime){reportLoadStatus()}else{setTimeout(function(){reportLoadStatus()},pageTimeOut)}function reportPv(){var timestamp=+new Date();var m=[{"name":"fed.page.pv","its":timestamp,"suc":1,"code":0,"value":1,"dim":{"schema":schema}}];reportCustom(m,timestamp)}reportPv()})();(function(){var apiTimeObj={};var report=function(apiName,times,msg){var apiNameItem=apiTimeObj[apiName];if(apiNameItem){apiNameItem.outTimer&&clearTimeout(apiNameItem.outTimer);var timer=times-apiNameItem.startTime;var timestamp=+new Date();var m=[{"name":"fed.page.index","its":timestamp,"suc":timer>apiTimeOut?0:1,"code":0,"value":timer,"dim":{"path":apiName,"schema":schema},"exdesc":(apiNameItem.msg||msg)?(apiNameItem.msg+"||"+msg):""}];reportCustom(m,timestamp);delete apiTimeObj[apiName]}};var reportApiTime=function(apiName,status,times,msg){var apiNameItem=apiTimeObj[apiName];if(!apiNameItem&&status=="start"){apiTimeObj[apiName]={startTime:times,outTimer:null,msg:msg||""};apiTimeObj[apiName].outTimer=setTimeout(function(){report(apiName,+new Date(),msg)},apiTimeOut)}if(apiNameItem&&status=="end"){report(apiName,times,msg)}};var reportApiMess=function(apiName,msg,code){var timestamp=+new Date();var m=[{"name":"fed.page.indexMess","its":timestamp,"suc":1,"code":+code||1,"value":1,"dim":{"path":apiName,"schema":schema},"exdesc":msg||""}];reportCustom(m,timestamp)};var reportCustomData=function(oParms){var timestamp=+new Date();var m=[];for(var i=0;i<oParms.m.length;i++){m.push({"name":"fed.page.index","its":timestamp,"suc":1,"code":0,"value":oParms.m[i].value,"dim":{"path":oParms.m[i].path,"schema":oParms.schema||schema},"exdesc":""})}reportCustom(m,timestamp,oParms.pageview)};function reportFirstScreenTime(){if(!window.performanceInfo.firstScreenTime){window.performanceInfo.firstScreenTime=+new Date()}try{window.HUYASdk&&HUYASdk.eventReport({event:{pageType:window.performanceInfo.pageview,timestamp:Date.now(),status:"0",code:"200",targetName:"pageLoadSuccess"}})}catch(e){}}var handle={reportApiTime:reportApiTime,reportApiMess:reportApiMess,reportCustomData:reportCustomData,reportFirstScreenTime:reportFirstScreenTime};function distribute(arr){var fnName=arr.splice(0,1);handle[fnName]&&handle[fnName].apply(this,arr)}function resetReport(){var _hmt=window.performanceInfo._hmt||[];if(_hmt.length){for(var i=0;i<_hmt.length;i++){distribute(_hmt[i])}}window.performanceInfo._hmt=[];window.performanceInfo._hmt.push=function(arr){distribute(arr)}}resetReport()})()})();